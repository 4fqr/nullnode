# NullSector Lab - Docker Image
# Kali Linux-based ephemeral hacking lab environment
# Includes: ttyd, nmap, sqlmap, Metasploit, OWASP Juice Shop, and more

FROM kalilinux/kali-rolling:latest

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive
ENV TERM=xterm-256color

# Update and install base tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Build tools for ttyd
    build-essential \
    cmake \
    libwebsockets-dev \
    libjson-c-dev \
    libssl-dev \
    # Terminal and session management
    tmux \
    vim \
    nano \
    git \
    curl \
    wget \
    # Network scanning and enumeration
    nmap \
    netcat-openbsd \
    dnsutils \
    whois \
    traceroute \
    # Web application testing
    sqlmap \
    nikto \
    dirb \
    gobuster \
    wfuzz \
    # Exploitation frameworks
    metasploit-framework \
    # Vulnerability analysis (exploitdb package contains searchsploit)
    exploitdb \
    # Password cracking
    john \
    hashcat \
    hydra \
    # Binary analysis and reverse engineering
    radare2 \
    gdb \
    strace \
    ltrace \
    binutils \
    # Python and scripting
    python3 \
    python3-pip \
    python3-requests \
    python3-scapy \
    # Node.js for Juice Shop
    nodejs \
    npm \
    # Utilities
    jq \
    unzip \
    p7zip-full \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Install ttyd from source (not available in Kali repos)
RUN git clone --depth 1 https://github.com/tsl0922/ttyd.git /tmp/ttyd && \
    cd /tmp/ttyd && \
    mkdir build && cd build && \
    cmake .. && \
    make && \
    make install && \
    cd / && rm -rf /tmp/ttyd

# Install OWASP Juice Shop (vulnerable web application)
WORKDIR /opt
RUN git clone --depth 1 https://github.com/juice-shop/juice-shop.git && \
    cd juice-shop && \
    npm ci --production --unsafe-perm && \
    npm cache clean --force

# Create lab user (non-root)
RUN useradd -m -s /bin/bash labuser && \
    echo "labuser:nullsector" | chpasswd && \
    usermod -aG sudo labuser

# Set up lab environment
WORKDIR /home/labuser
RUN mkdir -p /home/labuser/tools /home/labuser/targets /home/labuser/workspace

# Create welcome message
RUN echo '#!/bin/bash' > /home/labuser/.welcome.sh && \
    echo 'cat << EOF' >> /home/labuser/.welcome.sh && \
    echo "" >> /home/labuser/.welcome.sh && \
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" >> /home/labuser/.welcome.sh && \
    echo "â•‘                                                                  â•‘" >> /home/labuser/.welcome.sh && \
    echo "â•‘  â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•—         â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â•‘" >> /home/labuser/.welcome.sh && \
    echo "â•‘  â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘         â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•‘" >> /home/labuser/.welcome.sh && \
    echo "â•‘  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘         â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•‘" >> /home/labuser/.welcome.sh && \
    echo "â•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘         â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•‘" >> /home/labuser/.welcome.sh && \
    echo "â•‘  â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•‘" >> /home/labuser/.welcome.sh && \
    echo "â•‘  â•šâ•â•  â•šâ•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•    â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â• â•‘" >> /home/labuser/.welcome.sh && \
    echo "â•‘                                                                  â•‘" >> /home/labuser/.welcome.sh && \
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> /home/labuser/.welcome.sh && \
    echo "" >> /home/labuser/.welcome.sh && \
    echo "Welcome to NullSector Lab - Ephemeral Hacking Environment" >> /home/labuser/.welcome.sh && \
    echo "" >> /home/labuser/.welcome.sh && \
    echo "âš ï¸  IMPORTANT RULES:" >> /home/labuser/.welcome.sh && \
    echo "   â€¢ This environment is ISOLATED (no internet access)" >> /home/labuser/.welcome.sh && \
    echo "   â€¢ Session expires in 15 minutes" >> /home/labuser/.welcome.sh && \
    echo "   â€¢ For educational purposes ONLY" >> /home/labuser/.welcome.sh && \
    echo "   â€¢ Practice ethical hacking responsibly" >> /home/labuser/.welcome.sh && \
    echo "" >> /home/labuser/.welcome.sh && \
    echo "ðŸ”§ AVAILABLE TOOLS:" >> /home/labuser/.welcome.sh && \
    echo "   â€¢ nmap, masscan, netcat - Network scanning" >> /home/labuser/.welcome.sh && \
    echo "   â€¢ sqlmap, nikto, dirb - Web testing" >> /home/labuser/.welcome.sh && \
    echo "   â€¢ metasploit - Exploitation framework" >> /home/labuser/.welcome.sh && \
    echo "   â€¢ john, hashcat, hydra - Password cracking" >> /home/labuser/.welcome.sh && \
    echo "   â€¢ radare2, gdb - Binary analysis" >> /home/labuser/.welcome.sh && \
    echo "" >> /home/labuser/.welcome.sh && \
    echo "ðŸŽ¯ TARGETS:" >> /home/labuser/.welcome.sh && \
    echo "   â€¢ OWASP Juice Shop at http://localhost:3000" >> /home/labuser/.welcome.sh && \
    echo "     (Run: cd /opt/juice-shop && npm start)" >> /home/labuser/.welcome.sh && \
    echo "" >> /home/labuser/.welcome.sh && \
    echo "ðŸ“ QUICK START:" >> /home/labuser/.welcome.sh && \
    echo "   â€¢ ls ~/tools        - View available scripts" >> /home/labuser/.welcome.sh && \
    echo "   â€¢ ls ~/targets      - View target information" >> /home/labuser/.welcome.sh && \
    echo "   â€¢ cd ~/workspace    - Your working directory" >> /home/labuser/.welcome.sh && \
    echo "" >> /home/labuser/.welcome.sh && \
    echo "Type 'help' for a list of commands. Happy hacking! ðŸš€" >> /home/labuser/.welcome.sh && \
    echo "" >> /home/labuser/.welcome.sh && \
    echo 'EOF' >> /home/labuser/.welcome.sh && \
    chmod +x /home/labuser/.welcome.sh

# Add welcome to .bashrc
RUN echo '' >> /home/labuser/.bashrc && \
    echo '# NullSector Lab welcome' >> /home/labuser/.bashrc && \
    echo 'if [ -f ~/.welcome.sh ]; then' >> /home/labuser/.bashrc && \
    echo '    ~/.welcome.sh' >> /home/labuser/.bashrc && \
    echo 'fi' >> /home/labuser/.bashrc

# Create helpful aliases
RUN echo '' >> /home/labuser/.bashrc && \
    echo '# Lab aliases' >> /home/labuser/.bashrc && \
    echo 'alias ll="ls -lah --color=auto"' >> /home/labuser/.bashrc && \
    echo 'alias scan="nmap -sV -sC"' >> /home/labuser/.bashrc && \
    echo 'alias juice="cd /opt/juice-shop && npm start"' >> /home/labuser/.bashrc

# Create sample target info
RUN echo "# OWASP Juice Shop" > /home/labuser/targets/juice-shop.txt && \
    echo "URL: http://localhost:3000" >> /home/labuser/targets/juice-shop.txt && \
    echo "Description: Intentionally insecure web application" >> /home/labuser/targets/juice-shop.txt && \
    echo "Vulnerabilities: SQL Injection, XSS, CSRF, and more" >> /home/labuser/targets/juice-shop.txt && \
    echo "" >> /home/labuser/targets/juice-shop.txt && \
    echo "To start: cd /opt/juice-shop && npm start" >> /home/labuser/targets/juice-shop.txt

# Create sample recon script
RUN echo '#!/bin/bash' > /home/labuser/tools/quick-recon.sh && \
    echo '# Quick reconnaissance script' >> /home/labuser/tools/quick-recon.sh && \
    echo 'echo "[*] Starting quick recon on $1"' >> /home/labuser/tools/quick-recon.sh && \
    echo 'echo "[*] Port scan..."' >> /home/labuser/tools/quick-recon.sh && \
    echo 'nmap -sV -p- $1' >> /home/labuser/tools/quick-recon.sh && \
    chmod +x /home/labuser/tools/quick-recon.sh

# Set ownership
RUN chown -R labuser:labuser /home/labuser

# Switch to lab user
USER labuser
WORKDIR /home/labuser

# Expose ttyd port
EXPOSE 7681

# Start ttyd terminal server
# --writable: Allow terminal input
# --once: Close server after client disconnects
# --port: Listen port
# bash: Shell to run
CMD ["ttyd", "--writable", "--once", "--port", "7681", "bash"]
